<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  
  <?include Variables.wxi ?>

  <Package Name="$(var.ProductName)"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.Manufacturer)"
           UpgradeCode="$(var.UpgradeCode)"
           Language="1033"
           Compressed="yes"
           InstallerVersion="500"
           Scope="perMachine">

    <SummaryInformation Description="$(var.ProductDescription)"
                       Comments="$(var.ProductComments)"
                       Manufacturer="$(var.Manufacturer)" />

    <!-- Major Upgrade Strategy: Upgrade existing installations -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  Schedule="afterInstallInitialize"
                  AllowSameVersionUpgrades="yes" />

    <!-- Ensure .NET 10 Runtime is installed -->
    <util:RegistrySearch Root="HKLM"
                        Key="SOFTWARE\dotnet\Setup\InstalledVersions\x64\sharedhost"
                        Value="Version"
                        Result="value"
                        Variable="DotNetVersion" />
    
    <Launch Condition="DotNetVersion &gt;= v10.0"
            Message="This application requires .NET 10.0 Runtime or later. Please install it from https://dotnet.microsoft.com/download" />

    <!-- Media / Cabinet Configuration -->
    <Media Id="1" Cabinet="StorageWatch.cab" EmbedCab="yes" />

    <!-- Icon for Add/Remove Programs -->
    <Icon Id="ProductIcon" SourceFile="icon.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/tuckerproject/DiskSpaceService" />
    <Property Id="ARPHELPLINK" Value="https://github.com/tuckerproject/DiskSpaceService/issues" />

    <!-- Properties for customization -->
    <Property Id="INSTALLFOLDER" Secure="yes">
      <RegistrySearch Id="FindInstallLocation"
                      Root="HKLM"
                      Key="Software\[Manufacturer]\[ProductName]"
                      Name="InstallLocation"
                      Type="raw" />
    </Property>

    <!-- Desktop Shortcut Option -->
    <Property Id="INSTALLDESKTOPSHORTCUT" Value="1" />

    <!-- Service Account Configuration -->
    <Property Id="SERVICEACCOUNT" Value="LocalSystem" />
    <Property Id="SERVICEPASSWORD" Secure="yes" />

    <!-- Feature: Complete Installation -->
    <Feature Id="Complete" Level="1" ConfigurableDirectory="INSTALLFOLDER">
      <ComponentGroupRef Id="ServiceComponents" />
      <ComponentGroupRef Id="UIComponents" />
      <ComponentGroupRef Id="ConfigComponents" />
      <ComponentGroupRef Id="PluginComponents" />
      <ComponentGroupRef Id="StartMenuComponents" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="RegistryEntries" />
    </Feature>

    <!-- Custom UI -->
    <UIRef Id="StorageWatchUI" />

    <!-- Custom Actions -->
    <CustomAction Id="CreatePluginFolder"
                  Directory="PLUGINFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  ExeCommand="[SystemFolder]cmd.exe /c mkdir &quot;[PLUGINFOLDER]&quot;" />

    <CustomAction Id="CreateLogsFolder"
                  Directory="LOGSFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  ExeCommand="[SystemFolder]cmd.exe /c mkdir &quot;[LOGSFOLDER]&quot;" />

    <CustomAction Id="CreateDataFolder"
                  Directory="DATAFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check"
                  ExeCommand="[SystemFolder]cmd.exe /c mkdir &quot;[DATAFOLDER]&quot;" />

    <CustomAction Id="SetPermissionsOnProgramData"
                  Directory="CONFIGFOLDER"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore"
                  ExeCommand='[SystemFolder]icacls.exe &quot;[CONFIGFOLDER]&quot; /grant Users:(OI)(CI)M /T' />

    <CustomAction Id="LaunchUI"
                  Directory="UIFOLDER"
                  ExeCommand="[UIFOLDER]$(var.UIExeName)"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="asyncNoWait" />

    <InstallExecuteSequence>
      <Custom Action="CreatePluginFolder" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="CreateLogsFolder" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="CreateDataFolder" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="SetPermissionsOnProgramData" Before="InstallFinalize">NOT Installed</Custom>
    </InstallExecuteSequence>

    <InstallUISequence>
      <Custom Action="LaunchUI" After="InstallFinalize">LAUNCHUI = "1"</Custom>
    </InstallUISequence>

  </Package>
</Wix>
